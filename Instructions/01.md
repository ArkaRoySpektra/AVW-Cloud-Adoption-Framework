# Exercise 1: Start

## Context

The Enterprise-Scale architecture is modular by design and allows organizations to start with foundational landing zones that support their application portfolios, regardless of whether the applications are being migrated or are newly developed and deployed to Azure. The architecture enables organizations to start as small as needed and scale alongside their business requirements regardless of scale point.
The Wing Tip company wants to start with Landing Zones for their workload in Azure, where hybrid connectivity to their on-premise data center is not required from the start. 

### Reference architecture

The Enterprise-Scale architecture is modular by design and allow organizations to start with foundational landing zones that support their application portfolios and add hybrid connectivity with ExpressRoute or VPN when required. Alternatively, organizations can start with an Enterprise-Scale architecture based on the traditional hub and spoke network topology if customers require hybrid connectivity to on-premises locations from the beginning.

A hub and spoke network topology allows you to create a central Hub VNet that contains shared networking components (such as Azure Firewall, ExpressRoute and VPN Gateways) that can then be used by spoke VNets, connected to the Hub VNet via VNET Peering, to centralize connectivity in your environment. Gateway transit in VNet peering allows spokes to have connectivity to/from on-premises via ExpressRoute or VPN, and also, [transitive connectivity](https://azure.microsoft.com/en-us/blog/create-a-transit-vnet-using-vnet-peering/) across spokes can be implemented by deploying User Defined Routes (UDR) on the spokes and using Azure Firewall or an NVA in the hub as the transit resource. Hub and spoke network design considerations & recommendations can be found [here](https://docs.microsoft.com/en-us/azure/cloud-adoption-framework/ready/azure-best-practices/traditional-azure-networking-topology).

![](images/architecture01.png) 

## Customer profile

This reference implementation is ideal for customers that have started their Enterprise-Scale journey with an Enterprise-Scale foundation implementation and then there is a need to add connectivity on-premises datacenters and branch offices by using a traditional hub and spoke network architecture. This reference implementation is also well suited for customers who want to start with Landing Zones for their net new
deployment/development in Azure by implementing a network architecture based on the traditional hub and spoke network topology.

## In this Section

- [Task 1: Deploy Enterprise-Scale with hub and spoke architecture](#)
- [Validation post deployment (GitHub)](#validation-post-deployment-github)
- [Post deployment activities](#post-deployment-activities)
- [Operating the Azure platform using AzOps (Infrastructure as Code with GitHub Actions)](#operating-the-azure-platform-using-azops-infrastructure-as-code-with-github-actions)

## Task 1: Deploy Enterprise-Scale with hub and spoke architecture

In this task, you are deploying the Enterprise-Scale with hub and spoke architecture. To start with deploying, we will use the AdventureWorks reference implementation ARM template. 
1. Copy the below url and paste it in the new tab in edge browser inside your JumpHost where you have already logged in to Azure portal, if credentials window popup again then enter Azure credentials provided below.
    * Email/Username: <inject key="AzureAdUserEmail"></inject>
    * Password: <inject key="AzureAdUserPassword"></inject>

```
https://portal.azure.com/#blade/Microsoft_Azure_CreateUIDef/CustomDeploymentBlade/uri/https%3A%2F%2Fraw.githubusercontent.com%2FAzure%2FEnterprise-Scale%2Fmain%2FeslzArm%2FeslzArm.json/uiFormDefinitionUri/https%3A%2F%2Fraw.githubusercontent.com%2FAzure%2FEnterprise-Scale%2Fmain%2FeslzArm%2Feslz-portal.json
```

2. On the **Custom deployment** blade, in the `Deployment location` section, choose the **Region** as `Central US` and click on **Next: Azure core setup.**

   ![](images/deploymentlocation01.png)

3. On the **Azure corp setup** section, provide a Management Group prefix (for this lab, we will use **eslz** as the prefix).
   - Management Group prefix: `eslz` (1)
   - Select dedicated subscriptions or single subscription for platformresources: `Dedicated (recommended)`  (2)
   - Please click **Next: Platform management, security, and governance >** (3) to move to the next section.

     ![](images/azurecorpsetup01.png)
   
4. On the **Platform management, security, and governance** section, select **Yes(recommended)**(1) option for **Deploy Azure Security Center and enable security monitoring for your platform and resources**.
   - Management subscription: `L3 - ES Management Sub - suffix` (2)
   - Azure Security Center Email Contact: <inject key="AzureAdUserEmail"></inject> (3)
   - Leave the other options set to default and click on **Next : Platform DevOps and automation >** (4)

     ![](images/platformmanagement01.png)
   
5. Genrate GitHub personal access token:
   - To create a PA token, follow the instructions here: https://docs.github.com/en/github/authenticating-to-github/creating-a-personal-access-token
   - Ensure the PA token has the following permissions:

     ![Graphical user interface, text, application  Description automatically generated](images/github_developer_createPAT.png)
   
6. On **Platform DevOps and automation** section, make sure for `Deploy integrated CICD pipeline` **Yes** option is selected, then
   - GitHub Organization or username: enter your GitHub account username (1)
   - New GitHub repository name: `eslz` (2)
   - GitHub personal access token: Use the token which you have generated in previous step
   - Service Principal Type: `Create New` (4)
   - Service Principal: Make selection (5), proceed to next step to create service Principal.
   
     ![](images/devopsplatform01.png)

7. On **Register an application** blade, enter following details:
   - Name: `eslzsp`
   - In support account types choose **Accounts in this organizational directory only (Azure HOL Suffix only - Single tenant)**
   - Now, click on **Register** button to register teh application and move to the next step.

     ![](images/registerapplication.png)

8. After regitering teh application, application blade will open automatically. In that click on **+ New Client secret** (2) under **Certificates and secrets** (1). 

   ![](images/appcertificates.png)
   
9. Now, on **Add a client Secret** blade, enter following:
   - Description: `eslzsp-secret`
   - Expires: Leave Default
   - Now, click on **Add**, and move to next step.

     ![](images/appcertificates.png)
     
  



### Deployment location

On the first page, select the *Region*. This region will primarily be used to place the deployment resources in an Azure region, but also used as the initial region for some of the resources that are deployed, such as Azure Log Analytics and Azure automation.

![Graphical user interface, text, application, email  Description automatically generated](images/clip_image010.jpg)

### Enterprise-Scale core setup

Provide a prefix that will be used to create the management group hierarchy and platform resources, and select if you would use dedicated subscriptions or a single subscription for platform resources (please note that dedicates subscriptions are recommended). For this scenario, select Dedicated.

![ESLZ-Company-Prefix](images/ESLZ-Company-Prefix.JPG)

### Platform management, security, and governance

On the *Platform management, security, and governance* blade, you will configure the core components to enable platform monitoring and security. The options you enable will also be enforced using Azure Policy to ensure resources, landing zones, and more are continuously compliant as your deployments scales and grows. To enable this, you must provide a dedicated (empty) subscription that will be used to host the requisite infrastructure.

![Graphical user interface, text, application  Description automatically generated](images/clip_image014.jpg)

Please note that if you enable the "Deploy Azure Security Center and enable security monitoring for your platform and resources" option, you will need to provide an email address to get email notifications from Azure Security Center.

![Azure Security Center Email Contact](images/clip_image014asc.jpg)

### Platform DevOps and Automation

You can choose to bootstrap your CI/CD pipeline (GitHub with GitHub actions). Provide your GitHub user/org name, the preferred name of the GitHub repository that is to be created, as well as the PA token that the deployment will use to create a new repository and discover the Enterprise-Scale deployment ARM templates and merge them into your main branch.

![Graphical user interface, text, application  Description automatically generated](images/clip_image015.png)

1.1.1    To create a PA token, follow the instructions here: https://docs.github.com/en/github/authenticating-to-github/creating-a-personal-access-token

1.1.2    Ensure the PA token has the following permissions:

![Graphical user interface, text, application  Description automatically generated](images/github_developer_createPAT.png)

> For Microsoft employees who are enrolled into the Azure GitHub organization, you must also authorize the PA token to this Org!

![Graphical user interface, text, application, email  Description automatically generated](images/github_developer_enablesso.png)

![Graphical user interface, text, application, email  Description automatically generated](images/github_developer_disablesso.png)

1.2  Lastly, a Service Principal is required for Git to authenticate to – and be authorized to your Azure tenant. You can either use an existing Service Principal or create a new one. The Service Principal will be granted *Owner* permission on the top level Management Group that gets created.

1.2.1    If using an existing Service Principal, ensure you have the *client secret* as this must be provided as the *Password* for the service principal and confirm it has the right level of permission.

![Graphical user interface, text, application  Description automatically generated](images//clip_image020.jpg)

1.2.2    If creating a new Service Principal, select "Create New" and click on Make selection” and the portal will open a new blade for app registration

![img](images/clip_image022.png)

 ![img](images/clip_image024.png)

Once the App has been registered, you must explicitly create a new secret.

 ![img](images/clip_image026.png)

 ![img](images/clip_image028.jpg)

Make sure to note down the “Value” of the new client secret.
 ![img](images/clip_image030.jpg)

The default API Permissions for this App are “User.Read”, as depicted below:

![img](images/clip_image032.jpg)

 After copying the secret, go to “Enterprise-Scale Landing Zones” (in the upper left) to return to the deployment.

 ![img](images/clip_image034.png)

 At this point, paste the client secret value of the newly created client secret from a few step above into the Password field.

 ![Graphical user interface, application  Description automatically generated](images/clip_image035.png)


### Network topology and connectivity
On the *Network topology and connectivity* blade, you will configure the core networking platform resources, such as hub virtual network, gateways (VPN and/or ExpressRoute), Azure Firewall, DDoS Protection Standard and Azure Private DNS Zones for Azure PaaS services. To deploy and configure these network resources, you must select a network topology (for this scenario, select either "Hub and spoke with Azure Firewall" or "Hub and spoke with your own third-party NVA"), provide the address space to be assigned to the hub virtual network, select an Azure region where the hub virtual network will be created and provide a dedicated (empty) subscription that will be used to host the requisite infrastructure. For this example, we will select the "Hub and spoke with Azure Firewall" network topology.

 ![img](images/clip_image036a.png)

Depending on your requirements, you may choose to deploy additional network infrastructure for your Enterprise-Scale landing zones platform. The optional resources include:

* DDoS Protection Standard
* Azure Private DNS Zones for Azure PaaS services
* VPN and ExpressRoute Gateways
  * If you choose to deploy either or both of these gateways, you will have the option to select the subnet to be dedicated for these resources, if you decide to deploy them as regional or zone-redundant gateways, as well as choose the right SKU based on your requirements
* Azure Firewall
  * If you choose to deploy Azure Firewall, you will have the option to select the subnet, select to deploy the Firewall as regional or zone redundant as well as indicate if you want to enable DNS Proxy in Azure Firewall

 ![img](images/clip_image036b.png)


### Identity
On the *Identity* blade you can specify if you want to assign recommended policies to govern identity and domain controllers. If you decide to enable this feature, you to need provide an empty subscription for this. You can then select which policies you want to get assigned, and you will need to provide the address space for the virtual network that will be deployed on this subscription. Please note that this virtual network will be connected to the hub virtual network via VNet peering. 

 ![img](images/clip_image036c.png)

### Landing zone configuration

You can optionally bring in N number of subscriptions that will be bootstrapped as landing zones, governed by Azure Policy. You indicate which subscriptions will be bootstrapped as landing zones with a virtual network deployed and connected to the hub virtual network for corp connectivity. Virtual networks on these subscriptions will be connected to the hub virtual network using VNet peering, and if you deployed and enabled Azure Firewall as DNS proxy, DNS settings on these VNets will be configured with the Azure Firewall private IP address.

You can also indicate which subscriptions you would like to be bootstrapped as landing zones but without corp connectivity. Finally, you can select which policy you want to assign broadly to all of your landing zones.

As part of the policies that you can assign to your landing zones, the Enterprise-Scale Landing Zones deployment experience will allow you to protect your landing zones with a DDoS Standard plan, and for corp connected landing zones, you will have the option to prevent usage of public endpoints for Azure PaaS services as well as ensure that private endpoints to Azure PaaS services are integrated with Azure Private DNS Zones. 

![Graphical user interface, application  Description automatically generated](images/clip_image037.jpg)

### Review + create

*Review + Create* page will validate your permission and configuration before you can click deploy. Once it has been validated successfully, you can click *Create*

![Graphical user interface, text, application, email  Description automatically generated](images/clip_image039.jpg)

### Validation post deployment (GitHub)

Once Enterprise-Scale has deployed and you enabled the CI/CD bootstrap, you should validate in your GitHub account that:

*    A new repository has been created, with the name provided during setup.

![Graphical user interface, text, application  Description automatically generated](images/clip_image040.png)

*    4 Secrets are created into this GitHub repository.

ARM_CLIENT_ID = Service Principal

ARM_CLIENT_SECRET = Service Principal Client Secret created in the Tenant
ARM_SUBSCRIPTION_ID = The management subscription ID created in the Tenant
ARM_TENANT_ID = Tenant ID of the Azure Tenant that was used to create ESLZ

![img](images/clip_image042.jpg)

*    A Pull Request is either in progress or has completed and automatically merged into the main branch.

![img](images/clip_image044.png)

*    The Azure hierarchy that got created using ARM templates as part of the Enterprise-Scale setup, such as management groups, subscription organization as well as policy definitions, policy assignments and role assignments are hydrated and organized into Git:

![Graphical user interface  Description automatically generated with medium confidence](images/clip_image046.jpg)


![Graphical user interface, application  Description automatically generated](images/clip_image048.jpg)

*    In each folder, you will find the ARM templates that were deployed at the scopes during the Enterprise-Scale setup. E.g., on the intermediate root group, you will find all policy definitions, and depending on the selection you made during the deployment, you will find resource templates in the platform subscriptions. Users can – whenever they are ready, start using these templates and bring their own templates to manage the platform using ARM templates and infrastructure as code.

![Graphical user interface, application  Description automatically generated](images/clip_image050.jpg)

## Post deployment activities

Once Enterprise-Scale has deployed, you can grant your application teams/business units access to their respective landing zones. Whenever there’s a need for a new landing zone, you can place them into their respective management groups (Online or Corp) given the characteristics of assumed workloads and their requirements.
