# Exercise 1: Start

## Context

The Enterprise-Scale architecture is modular by design and allows organizations to start with foundational landing zones that support their application portfolios, regardless of whether the applications are being migrated or are newly developed and deployed to Azure. The architecture enables organizations to start as small as needed and scale alongside their business requirements regardless of scale point.
The Wing Tip company wants to start with Landing Zones for their workload in Azure, where hybrid connectivity to their on-premise data center is not required from the start. 

### Reference architecture

The Enterprise-Scale architecture is modular by design and allow organizations to start with foundational landing zones that support their application portfolios and add hybrid connectivity with ExpressRoute or VPN when required. Alternatively, organizations can start with an Enterprise-Scale architecture based on the traditional hub and spoke network topology if customers require hybrid connectivity to on-premises locations from the beginning.

A hub and spoke network topology allows you to create a central Hub VNet that contains shared networking components (such as Azure Firewall, ExpressRoute and VPN Gateways) that can then be used by spoke VNets, connected to the Hub VNet via VNET Peering, to centralize connectivity in your environment. Gateway transit in VNet peering allows spokes to have connectivity to/from on-premises via ExpressRoute or VPN, and also, [transitive connectivity](https://azure.microsoft.com/en-us/blog/create-a-transit-vnet-using-vnet-peering/) across spokes can be implemented by deploying User Defined Routes (UDR) on the spokes and using Azure Firewall or an NVA in the hub as the transit resource. Hub and spoke network design considerations & recommendations can be found [here](https://docs.microsoft.com/en-us/azure/cloud-adoption-framework/ready/azure-best-practices/traditional-azure-networking-topology).

![](images/architecture01.png) 

## Customer profile

This reference implementation is ideal for customers that have started their Enterprise-Scale journey with an Enterprise-Scale foundation implementation and then there is a need to add connectivity on-premises datacenters and branch offices by using a traditional hub and spoke network architecture. This reference implementation is also well suited for customers who want to start with Landing Zones for their net new
deployment/development in Azure by implementing a network architecture based on the traditional hub and spoke network topology.

## In this Section

- [Task 1: Deploy Enterprise-Scale with hub and spoke architecture](#)
- [Validation post deployment (GitHub)](#validation-post-deployment-github)
- [Post deployment activities](#post-deployment-activities)
- [Operating the Azure platform using AzOps (Infrastructure as Code with GitHub Actions)](#operating-the-azure-platform-using-azops-infrastructure-as-code-with-github-actions)

## Task 1: Deploy Enterprise-Scale with hub and spoke architecture

In this task, you are deploying the Enterprise-Scale with hub and spoke architecture. To start with deploying, we will use the AdventureWorks reference implementation ARM template. 
1. Copy the below url and paste it in the new tab in edge browser inside your JumpHost where you have already logged in to Azure portal, if credentials window popup again then enter Azure credentials provided below.
    * Email/Username: <inject key="AzureAdUserEmail"></inject>
    * Password: <inject key="AzureAdUserPassword"></inject>

```
https://portal.azure.com/#blade/Microsoft_Azure_CreateUIDef/CustomDeploymentBlade/uri/https%3A%2F%2Fraw.githubusercontent.com%2FAzure%2FEnterprise-Scale%2Fmain%2FeslzArm%2FeslzArm.json/uiFormDefinitionUri/https%3A%2F%2Fraw.githubusercontent.com%2FAzure%2FEnterprise-Scale%2Fmain%2FeslzArm%2Feslz-portal.json
```

### Deployment Location
On the first page, select the Region. This region will primarily be used to place the deployment resources in an Azure region, but also used as the initial region for some of the resources that are deployed, such as Azure Log Analytics and Azure automation.

1. On the **Custom deployment** blade, in the `Deployment location` section, choose the **Region** as `Central US` and click on **Next: Azure core setup.** 

   ![](images/deploymentlocation01.png)

### Enterprise-Scale core setup
Provide a prefix that will be used to create the management group hierarchy and platform resources, and select if you would use dedicated subscriptions or a single subscription for platform resources (please note that dedicates subscriptions are recommended). For this scenario, select Dedicated.

1. On the **Azure corp setup** section, provide a Management Group prefix (for this lab, we will use **eslz** as the prefix).
   - Management Group prefix (1): `eslz` 
   - Select dedicated subscriptions or single subscription for platformresources (2): `Dedicated (recommended)`  
   - Please click **Next: Platform management, security, and governance >** (3) to move to the next section.

   ![](images/azurecorpsetup01.png)
   
   
### Platform management, security, and governance
On the Platform management, security, and governance blade, you will configure the core components to enable platform monitoring and security. The options you enable will also be enforced using Azure Policy to ensure resources, landing zones, and more are continuously compliant as your deployments scales and grows. To enable this, you must provide a dedicated (empty) subscription that will be used to host the requisite infrastructure.
   
1. On the **Platform management, security, and governance** section, select **Yes(recommended)**(1) option for **Deploy Azure Security Center and enable security monitoring for your platform and resources**.
   - Management subscription (2): `L3 - ES Management Sub - suffix`, here Suffix is some numeric value
   - Azure Security Center Email Contact (3): <inject key="AzureAdUserEmail"></inject>
   - Leave the other options set to default and click on **Next : Platform DevOps and automation >** (4) to move on next section.

   ![](images/platformmanagement01.png)
   
### Platform DevOps and Automation
You can choose to bootstrap your CI/CD pipeline (GitHub with GitHub actions). Provide your GitHub user/org name, the preferred name of the GitHub repository that is to be created, as well as the PA token that the deployment will use to create a new repository and discover the Enterprise-Scale deployment ARM templates and merge them into your main branch.
   
1. Genrate GitHub personal access token:
   - To create a PA token, follow the instructions here: https://docs.github.com/en/github/authenticating-to-github/creating-a-personal-access-token
   - Ensure the PA token has the following permissions:

   ![Graphical user interface, text, application  Description automatically generated](images/github_developer_createPAT.png)
   
2. On **Platform DevOps and automation** section, make sure for `Deploy integrated CICD pipeline` **Yes** option is selected, then
   - GitHub Organization or username: enter your GitHub account username (1)
   - New GitHub repository name: `eslz` (2)
   - GitHub personal access token: Use the token which you have generated in previous step
   - Service Principal Type: `Create New` (4)
   - Service Principal: Make selection (5), proceed to next step to create service Principal.
   
   ![](images/devopsplatform01.png)

3. On **Register an application** blade, enter following details:
   - Name: `eslzsp`
   - In support account types choose **Accounts in this organizational directory only (Azure HOL Suffix only - Single tenant)**
   - Now, click on **Register** button to register teh application and move to the next step.

   ![](images/registerapplication.png)

4. After regitering the application, application blade will open automatically. In that click on **+ New Client secret** (2) under **Certificates and secrets** (1). 

   ![](images/appcertificates.png)
   
5. Now, on **Add a client Secret** blade, enter following:
   - Description: `eslzsp-secret`
   - Expires: Leave Default
   - Now, click on **Add**, and move to next step.

   ![](images/add-secret.png)
   
6. Once you have added the service principal secret.  Under Client Secrets look for the secret `eslzsp-secret` which you have added in previous steps and **copy** the **secret value** using the copy icon (2) and make sure to note down the “Value” of the new client secret some where for next step. Now, click on **Azure landing zone accelerator** (3) to continue with the template deployment.
   
    ![](images/copy-secret.png)
    
7. **Platform DevOps and automation** section, enter the service principal secret value in **Password** (1) field which you have copied and then click on **Next: Network topology and connectivity** (2). 

    ![](images/paste-secret.png)
    
### Network topology and connectivity
On the Network topology and connectivity blade, you will configure the core networking platform resources, such as hub virtual network, gateways (VPN and/or ExpressRoute), Azure Firewall, DDoS Protection Standard and Azure Private DNS Zones for Azure PaaS services. To deploy and configure these network resources, you must select a network topology (for this scenario, select either "Hub and spoke with Azure Firewall" or "Hub and spoke with your own third-party NVA"), provide the address space to be assigned to the hub virtual network, select an Azure region where the hub virtual network will be created and provide a dedicated (empty) subscription that will be used to host the requisite infrastructure. For this example, we will select the "Hub and spoke with Azure Firewall" network topology.
 
1. For **Network toplogy and connectivity** section, select following:
    - Deploy networking topology (1): `Hub and spoke with Azure Firewall`
    - Subscription (2): `L1 - Connectivity Sub - Sufiix`, here Suffix is some numeric value
    - Region for the first networking hub (3): `Central US`
    - Deploy VPN Gateway (4): `Yes`, once you click on yes few options like Zone redundant, VPN Gateway SKU and subnet for will automatically get enabled, keep the default values for those.
    - Deploy ExpressRoute Gateway (5): `Yes`
    - Enable Azure Firewall as a DNS proxy (6): `Yes`
    - Select Availability Zones for Azure Firewall (7): `Select all`
    - Now, click on **Next : Identity >** (8) and move to the next step.

    ![](images/network-topology.png)
   
### Identity
On the Identity blade you can specify if you want to assign recommended policies to govern identity and domain controllers. If you decide to enable this feature, you do need to provide an empty subscription for this. You can then select which policies you want to get assigned, and you will need to provide the address space for the virtual network that will be deployed on this subscription. Please note that this virtual network will be connected to the hub virtual network via VNet peering.

1. On **Identity** section, select
    - Subscription (1): `L2 - Identity Sub - Suffix`, here Suffix is some numeric value.
    - Leave default value for all other options
    - Click on **Next: Landing zone configuration >** (2) to move to Landing zone configuration tab.

    ![](images/identity.png)
    
### Landing zone configuration
You can optionally bring in N number of subscriptions that will be bootstrapped as landing zones, governed by Azure Policy. You indicate which subscriptions will be bootstrapped as landing zones with a virtual network deployed and connected to the hub virtual network for corp connectivity. Virtual networks on these subscriptions will be connected to the hub virtual network using VNet peering, and if you deployed and enabled Azure Firewall as DNS proxy, DNS settings on these VNets will be configured with the Azure Firewall private IP address.

You can also indicate which subscriptions you would like to be bootstrapped as landing zones but without corp connectivity. Finally, you can select which policy you want to assign broadly to all of your landing zones.

As part of the policies that you can assign to your landing zones, the Enterprise-Scale Landing Zones deployment experience will allow you to protect your landing zones with a DDoS Standard plan, and for corp connected landing zones, you will have the option to prevent usage of public endpoints for Azure PaaS services as well as ensure that private endpoints to Azure PaaS services are integrated with Azure Private DNS Zones.
    
1. On **Landing zone configuration** section, select **Yes (recommended)** (1) for Connect corp landing zones to connectivity hub (optional)?, then from **Subscriptions** select **L3 - ES Landing Zones Sub - Suffix** and provide `10.50.0.0/24` (2) for Vitual Network Address space. Now, click on **Next : Review + create >** (3) to review the input parameters you have given and selected.

    ![](images/landingzone-01.png)
 
### Review + create
Review + Create page will validate your permission and configuration before you can click deploy. Once it has been validated successfully, you can click Create
 
2. Review the input parameteres which you have selected for each section/platform before clicking on the **Create** buttom. Once reviewed, click on the **Create** button to begin the deployment.

    ![](images/create-lz-01.png)

     > **Note**: Once deployment begins don't close the deployment page, so you can review the deployment status.
    
3. Once the template deployment is completed you will see **Your deployment is complete** message on deployment page. It will take almost 90 Minutes to succeed.

    ![](images/deployment-succeed-01.png)
    

### Validation post deployment (GitHub)





### Validation post deployment (GitHub)

Once Enterprise-Scale has deployed and you enabled the CI/CD bootstrap, you should validate in your GitHub account that:

*    A new repository has been created, with the name provided during setup.

![Graphical user interface, text, application  Description automatically generated](images/clip_image040.png)

*    4 Secrets are created into this GitHub repository.

ARM_CLIENT_ID = Service Principal

ARM_CLIENT_SECRET = Service Principal Client Secret created in the Tenant
ARM_SUBSCRIPTION_ID = The management subscription ID created in the Tenant
ARM_TENANT_ID = Tenant ID of the Azure Tenant that was used to create ESLZ

![img](images/clip_image042.jpg)

*    A Pull Request is either in progress or has completed and automatically merged into the main branch.

![img](images/clip_image044.png)

*    The Azure hierarchy that got created using ARM templates as part of the Enterprise-Scale setup, such as management groups, subscription organization as well as policy definitions, policy assignments and role assignments are hydrated and organized into Git:

![Graphical user interface  Description automatically generated with medium confidence](images/clip_image046.jpg)


![Graphical user interface, application  Description automatically generated](images/clip_image048.jpg)

*    In each folder, you will find the ARM templates that were deployed at the scopes during the Enterprise-Scale setup. E.g., on the intermediate root group, you will find all policy definitions, and depending on the selection you made during the deployment, you will find resource templates in the platform subscriptions. Users can – whenever they are ready, start using these templates and bring their own templates to manage the platform using ARM templates and infrastructure as code.

![Graphical user interface, application  Description automatically generated](images/clip_image050.jpg)

## Post deployment activities

Once Enterprise-Scale has deployed, you can grant your application teams/business units access to their respective landing zones. Whenever there’s a need for a new landing zone, you can place them into their respective management groups (Online or Corp) given the characteristics of assumed workloads and their requirements.
