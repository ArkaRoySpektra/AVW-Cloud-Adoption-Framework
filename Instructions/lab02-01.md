# Lab 02: AzGovViz- Azure Governance Visualizer - Setup


## Exercise 1: AzGovViz from Console

### Task 1: Execute as Service Principal

A Service Principal by default has no read permissions on Users, Groups and Service Principals, therefore we need to grant additional permissions in AAD

1. We need to Grant API permissions for the Service Principal´s Application, in Azure portal search for Active Directory *(1)* and click on **Azure Active Direcectory** from the search results *(2)*.

   ![](images/lab2img1.png)

2. Click on **App registrations** under Manage *(1)* and select the **eslzp** application *(2)* we created in lab 1.

   ![](images/lab2img2.png)

3. Now click on **API permissions** under **Manage** and then click on **+ Add a permission**.

   ![](images/lab2img3.png)

4. A side window **Request API permissions** will open, here click on **Microsoft Graph**

   ![](images/lab2img4.png)

5. Under Microsoft Graph select **Application permissions** *(1)*, and expand the group of permissions and select the following set of permissions.

   - Application / Application.Read.All *(2)*
   - Group / Group.Read.All *(3)*
   - User / User.Read.All *(4)*
   - Once all the mentioned permissions are selected, click on *Add permissions** button at the bottom.

   ![](images/lab2img5.png)

6. Now, click on **Grant Admin Consent** *(1)* and on the *Grant admin consent confirmation* click on **Yes** *(2)*

   ![](images/lab2img17.png)


### Task 2: Clone the AzGovViz repository

1. In your JumpVm click on start and open **Powershell Core**.

**Note:** Make sure the icon of powershell matches the icon in screenshot below.

   ![](images/lab2img21.png)


2. Run the following commands in powershell to clone the GitHub repository.

``` 
Set-Location "C:\Program Files\Git"
```

```
git clone "https://github.com/JulianHayward/Azure-MG-Sub-Governance-Reporting.git"
```

### Task 3: Run AzGovViz Console

1. Run the following command in powershell to connect to your Azure account.
>**Note:** Replace <TenantID> with your Tenant Id which can be found in your Azure active directory.

```
Connect-AzAccount -TenantId <TenantId> -UseDeviceAuthentication
```

2. Now the powershell will ask you to go to ```https://microsoft.com/devicelogin``` *(1)* and enter the code mentioned in powershell *(2)*.

   ![](images/lab2img7.png)

3. In a new browser tab, visit ```https://microsoft.com/devicelogin``` and enter the code mentioned in your poewrshell *(1)* then click on **Next** *(2)*.

   ![](images/lab2img18.png)

4. Now on **Pick an account** window select your Azure Account.

   ![](images/lab2img19.png)

5. On the **Are you trying to sign in to Microsoft Azure PowerShell?** promt, click on **Continue**.

       ![](images/lab2img20.png)

6. Once above steps are done, return to powershell and run the command below.

```
C:\'Program Files'\Git\Azure-MG-Sub-Governance-Reporting\pwsh\AzGovVizParallel.ps1 -ManagementGroupId eslz
```

7. Once the script is completed sucessfully and you get the below output, you can continue with next exercise.

   ![](images/lab2img22.png)


# Exercise 2: AzGovViz in Azure DevOps

### Task 1: Create AzDO Project

1. In a new browser tab, go to ```https://dev.azure.com``` and provide the following details then click on **Continue** *(3)*.

    - Project name: Replace the existing project name with **AzDO** *(1)*
    - Enter the captha code *(2)*

 ![](images/lab2img8.png)

### Task 2: Import AzGovViz Github repository

1. In Azure Devops, Click on **Repos** and select **Files**, and click on **Import**.

 ![](images/lab2img13.png)

2. In  *Import a Git repository* window, enter the following URL ```https://github.com/JulianHayward/Azure-MG-Sub-Governance-Reporting.git``` *(1)* and click on **Import** *(2)*.

 ![](images/lab2img14.png)

3. Once Import is succesful, you will receive the following message on screen.

 ![](images/lab2img15.png)


### Task 3: Create AzDO Service Connection

For the pipeline to authenticate and connect to Azure we need to create an AzDO Service Connection which basically is a Service Principal (Application)  


1. Click on **Project settings** *(1)* (located on the bottom left).

2. Under 'Pipelines' click on **Service connections** *(2)*.

3. Click on **Create service connection** *(3)*.

 ![](images/lab2img16.png)

4. Select the *New service connection* type **Azure Resource Manager** *(1)* and click *Next* *(2)*.

 ![](images/lab2img10.png)

4. For the authentication method select **Service principal (automatic)** *(1)* and click **Next** *(2)*.

 ![](images/lab2img11.png)

5. For the 'Scope level' select ```Management Group``` *(1)*, in the Management Group dropdown select the target Management Group ```eszl``` *(2)*, in the 'Details' section apply a Service Connection name ```AzGovViz_SC``` *(3)*  and click on **Save** *(4)*.

 ![](images/lab2img12.png)


7. Now the Service Connection has been created.

### Task 4: Grant permissions in Azure

1. On the 'Service Connections' page click on **AzGovViz_SC** service principle.

 ![](images/lab2img23.png)

2. Under 'AzGovViz_SC' click on **Manage Service Principal**.

 ![](images/lab2img24.png)

 3. Now you will be redirected to Service principle page on Azure Portal, copy the **Display name** of the service principle by clicking on the copy icon and save it in notepad for later use.

  ![](images/lab2img25.png)

4. In Azure Portal search for **Management Groups** *(1)* and click on it from search results *(2)*.

 ![](images/lab2img26.png)

5. On 'Management groups' page click on **eslz**.

 ![](images/lab2img24.png)

6. Under 'eslz Management group' page, click on **Access control (IAM)** *(1)* then click on **+ Add** *(2)* and select **Add role assignment** *(3)* from the drop down.

 ![](images/lab2img28.png)

7. Now in 'Add role assignment' page, click on **Reader** *(1)* and then click on **Next** *(2)*.

 ![](images/lab2img29.png)

8. Now click on **+ Select members** *(1)*, then enter the display name of service principal we copied in step 3 *(2)* then click on the search result to select it and click on **Select** *(3)* button. Then Click on **Next** *(4)* and then **Review + assign**.

 ![](images/lab2img30.png)


### Task 5: Grant permissions in AAD

In this task we need to grant API permissions for the Service Principal´s Application that we created earlier.

1. We need to Grant API permissions for the Service Principal´s Application, in Azure portal search for Active Directory *(1)* and click on **Azure Active Direcectory** from the search results *(2)*.

   ![](images/lab2img1.png)

2. Click on **App registrations** under Manage *(1)* and select the **odluser-<Suffix>-AzDo-eslz** application *(2)*. Where Suffix is a unique numerical code.

   ![](images/lab2img31.png)

3. Now click on **API permissions** under 'Manage' and then click on **+ Add a permission**.

   ![](images/lab2img32.png)

4. A side window **Request API permissions** will open, here click on **Microsoft Graph**

   ![](images/lab2img4.png)

5. Under Microsoft Graph select **Application permissions** *(1)*, and expand the group of permissions and select the following set of permissions.

   - Application / Application.Read.All *(2)*
   - Group / Group.Read.All *(3)*
   - User / User.Read.All *(4)*
   - Once all the mentioned permissions are selected, click on *Add permissions** button at the bottom.

   ![](images/lab2img5.png)


6. Now, click on **Grant Admin Consent** *(1)* and on the *Grant admin consent confirmation* click on **Yes** *(2)*

   ![](images/lab2img17.png)


### Task 6: Grant permissions on AzGovViz AzDO repository

When the AzDO pipeline executes the AzGovViz script the outputs should be pushed back to the AzGovViz AzDO repository, in order to do this we need to grant the AzDO Project´s Build Service account with 'Contribute' permissions on the repository.
    
1. In AzDO click on '__Project settings__' (located on the bottom left), under '__Repos__' open the '__Repositories__' page

2. Click on the AzGovViz AzDO Repository and select the tab '__Security__'

3. On the right side search for the Build Service account  
     __%Project name% Build Service (%Organization name%)__ and grant it with '__Contribute__' permissions by selecting '__Allow__' (no save button available)

### Task 7: Edit AzDO YAML file

* Click on '__Repos__'
* Navigate to the AzGovViz Repository
* In the folder '__pipeline__' click on '__AzGovViz.yml__' and click '__Edit__'
* Under the variables section 
    * Enter the Service Connection name that you copied earlier (ServiceConnection)
    * Enter the Management Group Id (ManagementGroupId)
* Click '__Commit__'

### Task 8: Create AzDO Pipeline

* Click on '__Pipelines__'
* Click on '__New pipeline__'
* Select '__Azure Repos Git__'
* Select the AzGovViz repository
* Click on '__Existing Azure Pipelines YAML file__'
* Under '__Path__' select '__/pipeline/AzGovViz.yml__' (the YAML file we edited earlier)
* Click ' __Save__'

### Task 9: Run the AzDO Pipeline

* Click on '__Pipelines__'
* Select the AzGovViz pipeline
* Click '__Run pipeline__'

### Task 10: Create AzDO Wiki (WikiAsCode)

Once the pipeline has executed successfully we can setup our Wiki (WikiAsCode)

* Click on '__Overview__'
* Click on '__Wiki__'
* Click on '__Publish code as wiki__'
* Select the AzGovViz repository
* Select the folder '__wiki__' and click '__OK__'
* Enter a name for the Wiki
* Click '__Publish__'

# AzGovViz GitHub Codespaces

Note: Codespaces is available for organizations using GitHub Team or GitHub Enterprise Cloud. [Quickstart for Codespaces](https://docs.github.com/en/codespaces/getting-started/quickstart)

![alt text](img/codespaces0.png "AzGovViz GitHub Codespaces")  
![alt text](img/codespaces1.png "AzGovViz GitHub Codespaces")  
![alt text](img/codespaces2.png "AzGovViz GitHub Codespaces")  
![alt text](img/codespaces3.png "AzGovViz GitHub Codespaces")  
![alt text](img/codespaces4.png "AzGovViz GitHub Codespaces")
